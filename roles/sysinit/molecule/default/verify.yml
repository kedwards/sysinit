---
- name: Molecule Verify
  hosts: all
  become: true
  tasks:
    - name: Define required commands
      ansible.builtin.set_fact:
        required_commands:
          - aws
          - assume
          - curl
          - docker
          - gh
          - git
          - gpg
          - granted
          - jq
          - mise
          - node
          - op
          - python
          - starship

    - name: Check if mise binary exists
      ansible.builtin.stat:
        path: "/root/.local/bin/mise"
      register: mise_exists

    - name: Check if basic commands exist (simplified container verification)
      ansible.builtin.command: "which {{ item }}"
      register: cmd_check
      changed_when: false
      failed_when: false
      loop:
        - curl
        - git
        - gpg
        - python
        - docker  # Only on some distros
      when: item != 'docker' or ansible_os_family != 'Archlinux'

    - name: Verify mise installation
      ansible.builtin.fail:
        msg: "mise binary not found at expected path"
      when: not mise_exists.stat.exists

    - name: Collect successful commands
      ansible.builtin.debug:
        msg: "Basic system verification completed - mise binary exists and essential commands are available"
