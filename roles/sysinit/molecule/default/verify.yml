---
- name: Molecule Verify
  hosts: all
  become: true
  tasks:
    - name: Define required commands
      ansible.builtin.set_fact:
        required_commands:
          - aws
          - assume
          - curl
          - docker
          - gh
          - git
          - gpg
          - granted
          - jq
          - mise
          - node
          - op
          - python
          - starship

    - name: Check required commands are available with mise activated
      become: true
      become_user: "{{ lookup('env', 'USER') }}"
      ansible.builtin.shell: |
        set -euo pipefail
        eval "$(/home/{{ lookup('env', 'USER') }}/.local/bin/mise activate bash)"
      args:
        executable: /bin/bash
      register: cmd_check
      changed_when: false
      failed_when: false
      loop: "{{ required_commands }}"

    - name: Collect missing commands
      ansible.builtin.set_fact:
        missing_commands: "{{ cmd_check.results | selectattr('rc', 'ne', 0) | map(attribute='item') | list }}"

    - name: Fail if required command is missing
      ansible.builtin.fail:
        msg: "Required command(s) missing: {{ missing_commands | join(', ') }}"
      when: missing_commands | length > 0
