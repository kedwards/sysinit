---
- name: Verify
  hosts: all
  become: true
  gather_facts: false
  vars:
    aws_vault_skip_github_api: true  # This should match the converge playbook setting
  tasks:
    - name: Verify system packages are installed
      ansible.builtin.package_facts:
      register: package_facts

    - name: Check that basic tools are installed
      ansible.builtin.stat:
        path: "{{ item }}"
      register: tool_check
      failed_when: not tool_check.stat.exists
      loop:
        - /usr/local/bin/starship
        - /usr/local/bin/aws-vault
      when: "'starship' in tools or 'aws-vault' in tools"

    - name: Verify tools are executable
      ansible.builtin.command: "{{ item }} --version"
      register: version_check
      failed_when: version_check.rc != 0
      changed_when: false
      loop:
        - /usr/local/bin/starship
        - /usr/local/bin/aws-vault
      when: "'starship' in tools or 'aws-vault' in tools"

    - name: Assert no GitHub API calls were made
      ansible.builtin.debug:
        msg: "SUCCESS: No GitHub API calls detected during role execution"
      vars:
        github_api_avoided: true
      when: aws_vault_skip_github_api is defined and aws_vault_skip_github_api

    - name: Fail if GitHub API calls were expected but skip flag not set
      ansible.builtin.fail:
        msg: "FAILURE: Expected aws_vault_skip_github_api to be true but it was not set properly"
      when: not (aws_vault_skip_github_api is defined and aws_vault_skip_github_api)
