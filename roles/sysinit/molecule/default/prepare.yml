---
- name: Prepare
  hosts: all
  become: true
  gather_facts: false  # We can't gather facts without Python
  tasks:
    - name: Install Python and essential packages
      ansible.builtin.raw: |
        apt-get update
        apt-get install -y python3 python3-pip python3-setuptools curl wget gnupg2 software-properties-common sudo bison
        ln -sf /usr/bin/python3 /usr/bin/python
      register: install_python
      changed_when: install_python.rc == 0

    - name: Wait for apt lock to be released
      ansible.builtin.raw: |
        while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
        while fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 5; done
      changed_when: false

    - name: Install github3.py library
      ansible.builtin.raw: pip3 install --break-system-packages github3.py
      register: install_github3
      changed_when: install_github3.rc == 0

    - name: Gather facts after Python installation
      ansible.builtin.setup:

    - name: Create test user
      ansible.builtin.user:
        name: kedwards
        state: present
        create_home: true
        shell: /bin/bash
        groups: sudo
        append: true

    - name: Create .local directory structure for test user
      ansible.builtin.file:
        path: /home/kedwards/.local
        state: directory
        mode: '0755'
        owner: kedwards
        group: kedwards

    - name: Create .local/bin directory for test user
      ansible.builtin.file:
        path: /home/kedwards/.local/bin
        state: directory
        mode: '0755'
        owner: kedwards
        group: kedwards

    - name: Set ownership of user home directory
      ansible.builtin.file:
        path: /home/kedwards
        state: directory
        owner: kedwards
        group: kedwards
        recurse: true
