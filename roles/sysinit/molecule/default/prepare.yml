---
- name: Molecule Prepare
  hosts: all
  become: false
  gather_facts: false
  tasks:
    - name: Determine initial distribution
      ansible.builtin.raw: |
        if [ -f /etc/os-release ]; then
          . /etc/os-release
          echo "$ID"
        elif [ -f /etc/lsb-release ]; then
          . /etc/lsb-release
          echo "$DISTRIB_ID"
        elif [ -f /etc/redhat-release ]; then
          awk '{print $1}' /etc/redhat-release | tr '[:upper:]' '[:lower:]' | sed 's/centos/redhat/' | sed 's/scientific/redhat/'
        else
          echo "unknown"
        fi
      register: initial_distro_check
      changed_when: false
      failed_when: false

    - name: Set initial distribution fact
      ansible.builtin.set_fact:
        initial_distribution: "{{ initial_distro_check.stdout | trim }}"

    - name: Install Python and essential packages (APT)
      ansible.builtin.raw: |
        apt update
        apt install -y python3 python3-pip openssh-client python3-setuptools git curl wget gnupg2 sudo bison
        ln -sf /usr/bin/python3 /usr/bin/python
      register: install_python
      changed_when: install_python.rc == 0
      when: initial_distribution == 'debian' or initial_distribution == 'ubuntu'

    - name: Install Python and essential packages (PACMAN)
      ansible.builtin.raw: |
        pacman -Syu
        pacman -S --noconfirm python python-pip openssh python-setuptools git curl wget gnupg sudo bison base-devel fakeroot
      register: install_python
      changed_when: install_python.rc == 0
      when: initial_distribution == 'arch'

    - name: Install Python and essential packages (DNF)
      ansible.builtin.raw: |
        dnf install -y python3 python3-pip openssh python3-setuptools git curl wget gnupg2 sudo bison python3-libdnf5
      register: install_python
      changed_when: install_python.rc == 0
      when: initial_distribution == 'fedora'

    - name: Install github3.py library
      ansible.builtin.raw: pip3 install --break-system-packages github3.py
      register: install_github3
      changed_when: install_github3.rc == 0
      when: initial_distribution == 'debian' or initial_distribution == 'arch'

    - name: Install github3.py library
      ansible.builtin.raw: pip3 install github3.py
      register: install_github3
      changed_when: install_github3.rc == 0
      when: initial_distribution == 'fedora' or initial_distribution == 'ubuntu'

    - name: Gather facts after Python installation
      ansible.builtin.setup:

    - name: Set common non-root user fact
      ansible.builtin.set_fact:
        test_user: "{{ lookup('env', 'USER') }}"
        aur_user: "{{ lookup('env', 'USER') }}"

    - name: Create test user
      ansible.builtin.user:
        name: "{{ test_user }}"
        state: present
        create_home: true
        shell: /bin/bash
        groups: "{{ 'sudo' if initial_distribution in ['debian', 'ubuntu'] else 'wheel' }}"
        append: true

    - name: Create .ssh directory for test user
      ansible.builtin.file:
        path: "/home/{{ test_user }}/.ssh"
        state: directory
        mode: "0755"
        owner: "{{ test_user }}"
        group: "{{ test_user }}"
        recurse: true

    - name: Create .local/bin directory for test user
      ansible.builtin.file:
        path: "/home/{{ test_user }}/.local/bin"
        state: directory
        mode: "0755"
        owner: "{{ test_user }}"
        group: "{{ test_user }}"
        recurse: true

    - name: Set ownership of user home directory
      ansible.builtin.file:
        path: "/home/{{ test_user }}"
        state: directory
        owner: "{{ test_user }}"
        group: "{{ test_user }}"
        recurse: true

    - name: Allow passwordless sudo for wheel group (Arch)
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^%wheel ALL=\(ALL\) NOPASSWD: ALL'
        line: '%wheel ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'
      when: initial_distribution == 'arch'

    - name: Allow test user to run makepkg as root (Arch)
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^{{ test_user }} ALL=\(ALL\) NOPASSWD: /usr/bin/makepkg'
        line: '{{ test_user }} ALL=(ALL) NOPASSWD: /usr/bin/makepkg'
        validate: 'visudo -cf %s'
      when: initial_distribution == 'arch'

    - name: Allow passwordless sudo for sudo group (Debian/Ubuntu)
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^%sudo ALL=\(ALL:ALL\) NOPASSWD: ALL'
        line: '%sudo ALL=(ALL:ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'
      when: initial_distribution in ['debian', 'ubuntu']
