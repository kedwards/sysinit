---
- name: AWS - SSM - Exists
  ansible.builtin.stat:
    path: /usr/local/bin/sessionmanagerplugin
  register: awsssm_exists_result

- name: AWS - SSM - Install/Upgrade
  ansible.builtin.apt:
    deb: https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb
  when: (ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu') and (not awsssm_exists_result.stat.exists or upgrade)

- name: AWS - SSM - Install/Upgrade
  ansible.builtin.dnf:
    name: https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm
    disable_gpg_check: true
  when: ansible_distribution == 'Fedora' and (not awsssm_exists_result.stat.exists or upgrade)