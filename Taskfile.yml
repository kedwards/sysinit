version: "3"

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list-all

  check:
    desc: Run all pre-commit checks
    cmds:
      - pre-commit run --all-files
      - echo "✅ All checks passed"

  # Lint
  lint:
    desc: Run all linters
    deps: [lint:ansible, lint:shell]
    cmds:
      - echo "✅ All linters passed"

  lint:ansible:
    desc: Lint Ansible code
    cmds:
      - bash -c 'source .venv/bin/activate && ansible-playbook --syntax-check playbook.yml'
      - bash -c 'source .venv/bin/activate && ansible-lint playbook.yml roles/'
      - echo "✅ Ansible code linted"

  lint:shell:
    desc: Lint shell code
    cmds:
      - find . -name "*.sh" -type f -not -path "./.venv/*" | xargs shellcheck -e SC1091
      - echo "✅ Shell scripts linted"

  # Format
  format:
    desc: Format YAML files with prettier
    cmds:
      - find . -name "*.yml" -o -name "*.yaml" | grep -v node_modules | grep -v .venv | xargs prettier --write
      - echo "✅ YAML files formatted"

  # Molecule
  molecule:test:
    desc: Run Molecule tests for default scenario
    cmds:
      - bash -c 'source .venv/bin/activate && cd roles/sysinit && molecule test'
      - echo "✅ Molecule tests completed"

  molecule:converge:
    desc: Run Molecule converge for development
    cmds:
      - bash -c 'source .venv/bin/activate && cd roles/sysinit && molecule converge'
      - echo "✅ Molecule converge completed"

  molecule:verify:
    desc: Run Molecule verify only
    cmds:
      - bash -c 'source .venv/bin/activate && cd roles/sysinit && molecule verify'
      - echo "✅ Molecule verify completed"

  molecule:destroy:
    desc: Destroy Molecule test instances
    cmds:
      - bash -c 'source .venv/bin/activate && cd roles/sysinit && molecule destroy'
      - echo "✅ Molecule test instances destroyed"

  # Secrets
  secrets:scan:
    desc: Scan for secrets
    cmds:
      - bash -c 'source .venv/bin/activate && detect-secrets scan --baseline .secrets.baseline --force-use-all-plugins'
      - echo "✅ Secrets scanned"

  secrets:update:
    desc: Update secrets baseline
    cmds:
      - bash -c 'source .venv/bin/activate && git ls-files -z | xargs -0 detect-secrets-hook --baseline .secrets.baseline'
      - echo "✅ Secrets updated"

  secrets:audit:
    desc: Audit secrets baseline
    cmds:
      - bash -c 'source .venv/bin/activate && detect-secrets audit .secrets.baseline'
      - echo "✅ Secrets audited"

  # Install
  install:deps:
    desc: Install dependencies
    cmds:
      - if ! command -v prettier >/dev/null 2>&1; then echo "⚠️ prettier not found"; exit 1; fi
      - if ! command -v uv >/dev/null 2>&1; then echo "⚠️ uv not found"; exit 1; fi
      - if ! command -v shellcheck >/dev/null 2>&1; then echo -e "⚠️ shellcheck not found"; exit 1; fi
      - |+
        uv venv --clear
        uv pip install -r requirements.txt
        uv pip install -r development.requirements.txt
        bash -c 'source .venv/bin/activate && ansible-galaxy install -r requirements.yml'
      - echo "✅ Dependencies installed"

  install:hooks:
    desc: Install pre-commit hooks
    cmds:
      - pre-commit install
      - echo "✅ Pre-commit hooks installed"

  upgrade-deps:
    desc: Upgrade Python dependencies
    deps: ['install:deps']
    cmds:
      - uv pip install --upgrade pip
      - uv pip install --upgrade -r requirements.txt
      - uv pip install --upgrade -r development.requirements.txt
      - bash -c 'source .venv/bin/activate && ansible-galaxy install --force -r requirements.yml'
      - echo "✅ Dependencies upgraded"
