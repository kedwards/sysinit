---
version: "3"

vars:
  DEBUG: '{{.DEBUG | default "false"}}'
  ENV: '{{.AWS_ENV | default "dev"}}'
  PLAYBOOK: '{{.PLAYBOOK | default "playbooks/master.yml"}}'
  PYTHON: python3
  REDIRECT: '{{if eq .DEBUG "true"}}{{else}}2>&1 >/dev/null{{end}}'
  REGION: '{{.REGION | default "us-west-2"}}'
  VENV_DIR: .venv

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list-all

  check:
    desc: Run all pre-commit checks
    cmds:
      - pre-commit run --all-files
      - echo "✅ All checks passed"

  # Lint
  lint:
    desc: Run all linters
    deps: [lint:ansible, lint:shell]
    cmds:
      - echo "✅ All linters passed"

  lint-ansible:
    desc: Lint Ansible code
    deps: [setup]
    cmds:
      - echo "Running ansible-lint..."
      - "{{.VENV_DIR}}/bin/ansible-lint playbook.yml"
      - echo "✅ Ansible code linted"

  lint-shell:
    desc: Lint shell code
    cmds:
      - find . -name "*.sh" -type f -not -path "./.venv/*" | xargs shellcheck -e SC1091
      - echo "✅ Shell scripts linted"

  # Format
  format:
    desc: Format YAML files with prettier
    cmds:
      - find . -name "*.yml" -o -name "*.yaml" | grep -v node_modules | grep -v .venv | xargs prettier --write
      - echo "✅ YAML files formatted"

  # Molecule
  molecule-test:
    desc: Run Molecule tests for default scenario
    cmds:
      - bash -c 'source .venv/bin/activate && cd roles/sysinit && molecule test'
      - echo "✅ Molecule tests completed"

  molecule:converge:
    desc: Run Molecule converge for development
    cmds:
      - bash -c 'source .venv/bin/activate && cd roles/sysinit && molecule converge'
      - echo "✅ Molecule converge completed"

  molecule:verify:
    desc: Run Molecule verify only
    cmds:
      - bash -c 'source .venv/bin/activate && cd roles/sysinit && molecule verify'
      - echo "✅ Molecule verify completed"

  molecule:destroy:
    desc: Destroy Molecule test instances
    cmds:
      - bash -c 'source .venv/bin/activate && cd roles/sysinit && molecule destroy'
      - echo "✅ Molecule test instances destroyed"

  # Secrets
  secrets:scan:
    desc: Scan for secrets
    cmds:
      - bash -c 'source .venv/bin/activate && detect-secrets scan --baseline .secrets.baseline --force-use-all-plugins'
      - echo "✅ Secrets scanned"

  secrets:update:
    desc: Update secrets baseline
    cmds:
      - bash -c 'source .venv/bin/activate && git ls-files -z | xargs -0 detect-secrets-hook --baseline .secrets.baseline'
      - echo "✅ Secrets updated"

  secrets:audit:
    desc: Audit secrets baseline
    cmds:
      - bash -c 'source .venv/bin/activate && detect-secrets audit .secrets.baseline'
      - echo "✅ Secrets audited"

  setup:
    desc: Create virtual environment and install dependencies
    cmds:
      - echo "Creating virtual environment..."
      - "{{.PYTHON}} -m venv {{.VENV_DIR}} {{.REDIRECT}}"
      - echo "Installing Python dependencies..."
      - "{{.VENV_DIR}}/bin/pip install --upgrade pip {{.REDIRECT}}"
      - "{{.VENV_DIR}}/bin/pip install -r requirements.txt {{.REDIRECT}}"
      - echo "Installing Ansible collections..."
      - "{{.VENV_DIR}}/bin/ansible-galaxy collection install -r collections/requirements.yml {{.REDIRECT}}"
      - echo "Setup complete. Activate with 'source {{.VENV_DIR}}/bin/activate'"

  install:hooks:
    desc: Install pre-commit hooks
    cmds:
      - pre-commit install
      - echo "✅ Pre-commit hooks installed"
